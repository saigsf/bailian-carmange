<!doctype html>
<html>

<head>
  <meta charset="UTF-8">
  <title>线束检查</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-status-bar-style" content="black">
  <!--mui样式应用-->
  <link href="../css/mui.min.css" rel="stylesheet" />
  <!--自定义图标样式-->
  <link rel="stylesheet" type="text/css" href="../css/style-icon.css" />
  <!--自定义页面样式-->
  <link rel="stylesheet" type="text/css" href="../css/style-common.css" />
  <!--独立样式-->

  <style type="text/css">
    table {
      margin-top: 10px
    }
    table tbody tr td {
      border: 1px solid #eee;
      padding: 0
    }

    table tbody tr td:not(:last-of-type):after {
      display: none;
    }

    .explain,
    .resolvent {
      font-size: 24px;
    }

    .mui-popover {
      width: 140px;
    }

    .info-operator {
      flex-direction: column;
      margin-bottom: 20px
    }

    .info-operator-item {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }

    .info-operator-item p {
      width: 50%;
      margin: 0;
    }

    .info-operator-item span {
      display: inline;
    }
    .select-container select {
      padding-left: 18px;
      padding-right: 0;
    }
    #openPopover {
      display: none
    }
  </style>
</head>

<body>
  <header class="mui-bar mui-bar-nav">
    <a class="mui-action-back icon icon-back mui-pull-left"></a>
    <h1 class="mui-title">线束检查</h1>
    <a href="#popover" id="openPopover" class="mui-btn mui-btn-outlined mui-pull-right">修改</a>
  </header>
  <!--页面主内容区开始-->
  <div class="mui-content mui-scroll-wrapper" id="app">
    <div class="mui-scroll">
      <table>
        <thead>
          <tr>
            <td width="60%" colspan="2">检查项目</td>
            <td width="15%">状态</td>
            <td width="25%">检查进度</td>
            <!-- <td width="15%">解决</td> -->
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="info-operator">
        <div class="info-operator-item">
          <p>
            <span>检查人：</span>
            <span class="checkPerson"></span>
          </p>
          <p>
            <span>检查日期：</span>
            <span class="checkTime"></span>
          </p>

        </div>
        <div class="info-operator-item">
          <p>
            <span>核对人：</span>
            <span class="checkingPerson"></span>
          </p>
          <p>
            <span>核对日期：</span>
            <span class="checkingTime"></span>
          </p>
        </div>
      </div>

      <div class="btn-wrapper ">
        <div class="btn btn-blue" id="three_next">提交</div>
      </div>
    </div>
  </div>
  <!--页面主内容区结束-->
  <div id="popover" class="mui-popover">
    <ul class="mui-table-view">
      <li class="mui-table-view-cell">
        <a href="#">修改检查项</a>
      </li>
      <li class="mui-table-view-cell">
        <a href="#">修改核对项</a>
      </li>
    </ul>
  </div>


  <!-- jquery -->
  <script src="../js/lib/jquery.min.js"></script>
  <!-- mui -->
  <script src="../js/mui.min.js"></script>
  <!-- config 配置项 -->
  <script src="../js/app/config.js"></script>
  <!-- app 数据获取 -->
  <script src="../js/app/app.js"></script>
  <!-- 当前页面js -->
  <script type="text/javascript">
    var H = null;
    var self = null;
    var view = null;
    var vSn = '2018-512';
    var status = 'explain'
    var viewId = null;
    var state = null;
    var stateArr = [];
    var submitArr = ['addHiCheck']; // 检查接口
    var updateArr = ['updateHiCheckByvSn']; // 核对接口
    var submitLock = false; // 提交保护

    var canInspect = true; // 可以检查
    var canChecked = true; // 可以核对

    var isRevising = false; // 修改索订

    mui.init({
      beforeback: function(){
        //获得列表界面的webview
        let self = plus.webview.currentWebview();
        let view = plus.webview.getWebviewById(self.prevId)
        //触发列表界面的自定义事件（refresh）,从而进行数据刷新
        mui.fire(view,'update');
        //返回true，继续页面关闭逻辑
        return true;
      }
    });
    //初始化单页的区域滚动
    mui('.mui-scroll-wrapper').scroll();
    mui.plusReady(function () {
      handsetAdaption();
      $('.mui-scroll').css('min-height', $('.mui-content').height())
      self = plus.webview.currentWebview();
      view = plus.webview.getWebviewById(self.prevId)
      viewId = self.id;
      H = self.H;
      vSn = self.vSn;
      // state = self.state;
      state = app.getState();
      _init()
    })

    function handsetAdaption() {
      if (plus.device.model === 'iPhoneX') {
        //页面样式重置
        $('header').css({
          'height': '88px',
          'paddingTop': '40px'
        });
        $('.mui-bar-nav~.mui-content').css({
          'paddingTop': '88px'
        })
      }
      // plus.webview.currentWebview().setStyle({
      //   softinputMode: "adjustResize" // 弹出软键盘时自动改变webview的高度
      // });
    }

    // _init()
    // 表格初始化
    function _init() {
      var wireJson = [
        {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "点火线圈（柴油不查）",
          "item": "",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "EGR阀",
          "item": "",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "电子防盗器",
          "item": "",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "巡航控制",
          "item": "",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "前氧传感器",
          "item": "",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "后氧传感器",
          "item": "",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "曲轴位置传感器",
          "item": "",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "凸轮轴位置传感器",
          "item": "",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "水温传感器",
          "item": "",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "进气压力/温度传感器",
          "item": "",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "通讯",
          "item": "KW2000",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "通讯",
          "item": "CAN",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "E L O A D 信号",
          "item": "大灯负载信号",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "E L O A D 信号",
          "item": "鼓风机负载信号",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "E L O A D 信号",
          "item": "除雾负载信号",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "E L O A D 信号",
          "item": "助力转向开关",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "E L O A D 信号",
          "item": "其他电器负载信号",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "燃油供给系统",
          "item": "喷油器",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "燃油供给系统",
          "item": "油泵继电器",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "燃油供给系统",
          "item": "碳罐电磁阀",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "燃油供给系统",
          "item": "燃油箱油位传感器信号输出（输入ECM）",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "燃油供给系统",
          "item": "高压油泵控制阀（GDI)",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "燃油供给系统",
          "item": "高压油轨压力传感器（GDI）",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "燃油供给系统",
          "item": "喷嘴加热控制（Flex Fuel）",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "制动系统",
          "item": "刹车开关",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "制动系统",
          "item": "刹车灯",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "制动系统",
          "item": "制动真空度传感器信号输入（Turbo建议安装）",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "制动系统",
          "item": "真空泵ECM控制（Turbo建议安装）",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "制动系统",
          "item": "制动真空泵继电器",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "车速及轮速",
          "item": "轮速传感器",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "车速及轮速",
          "item": "车速传感器",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "仪表显示",
          "item": "瞬时油耗数据输出功能",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "仪表显示",
          "item": "汽车仪表水温数据显示输出",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "仪表显示",
          "item": "汽车仪表转速显示输出",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "仪表显示",
          "item": "仪表电源输入",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "仪表显示",
          "item": "SVS灯/MIL灯",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "空调系统",
          "item": "空调请求开关信号",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "空调系统",
          "item": "空调前蒸发器温度传感器是否接入ECM",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "空调系统",
          "item": "空调后蒸发器温度传感器是否接入ECM",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "空调系统",
          "item": "空调压力传感器",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "空调系统",
          "item": "独立冷凝器风扇继电器",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "空调系统",
          "item": "空调离合器继电器",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "空调系统",
          "item": "空调高低压开关",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "空调系统",
          "item": "空调中压开关",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "风扇控制",
          "item": "低速风扇继电器",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "风扇控制",
          "item": "高速风扇继电器",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "风扇控制",
          "item": "高低速中间继电器（五脚）",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "风扇控制",
          "item": "PWM风扇控制",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "风扇控制",
          "item": "可变进气通道",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "增压发动机",
          "item": "旁通阀",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "增压发动机",
          "item": "泄压阀",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "增压发动机",
          "item": "增压压力、温度传感器（Turbo）",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "增压发动机",
          "item": "大气压力、温度传感器（Turbo）",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "增压发动机",
          "item": "中冷风扇继电器",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "V V T",
          "item": "可变进气相位调节装置",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "V V T",
          "item": "进气油压控制阀",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "V V T",
          "item": "排气油压控制阀",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "水温电子控制",
          "item": "电子节温器",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "水温电子控制",
          "item": "电子水泵",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "水温电子控制",
          "item": "碰撞断油功能",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "发动机控制",
          "item": "发电机（LIN通讯）",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "发动机控制",
          "item": "发电机负载反馈输入信号",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "发动机控制",
          "item": "ECM控制发电机输出信号",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "发动机控制",
          "item": "充电指示灯是否受ECM控制",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "启停控制",
          "item": "起动请求信号",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "启停控制",
          "item": "起停系统主控制开关",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "启停控制",
          "item": "起动电机继电器",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "启停控制",
          "item": "空挡位置传感器",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "启停控制",
          "item": "空挡开关输入信号",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "启停控制",
          "item": "传动链状态输入信号",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "启停控制",
          "item": "发动机舱开关状态输入信号",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "启停控制",
          "item": "驾驶员侧车门开关信号输入起动机继电器控制（输出）",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "启停控制",
          "item": "起动机继电器控制（输出）信号",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "启停控制",
          "item": "起停系统工作状态指示灯输出信号",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "启停控制",
          "item": "起停系统警示灯输出信号",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "启停控制",
          "item": "怠速停机状态输出信号（屏蔽仪表机油灯，电池灯）",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "启停控制",
          "item": "蓄电池状态传感器",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "启停控制",
          "item": "离合器信号（顶部开关，底部开关）",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "机油温度/压力",
          "item": "机油温度传感器",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "机油温度/压力",
          "item": "机油压力传感器",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "进气流量控制",
          "item": "节气门位置传感器",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "进气流量控制",
          "item": "怠速步进电机",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "进气流量控制",
          "item": "电子节气门（ETC）",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "进气流量控制",
          "item": "电子油门踏板",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "爆震传感器",
          "item": "",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "checkingExplanation": "",
          "pitem": "加速度传感器",
          "item": "",
          "status": "Y"
        }
      ]
      var html = ''
      var pitem = ''
      mui.each(wireJson, function(k, item) {
        html += '<tr data-uuid="'+k+'">'

        if (item.item) {
          if (pitem == item.pitem) {
            html += '<td class="item">' + item.item + '</td>'
          } else {
            html += '<td class="pitem" width="10%" rowspan="'+ getCount(item.pitem, wireJson) +'">' + item.pitem + '</td>' +
              '<td class="item">' + item.item + '</td>'
          }
          pitem = item.pitem
        } else {
          html += '<td colspan="2" class="pitem">' + item.pitem + '</td>'
        }

        html += '<td>' +
          '<div class="select-container">' +
          '<select name="status" class="status">' +
          '<option value="Y">是</option>' +
          '<option value="N">否</option>' +
          '<option value="NA">NA</option>' +
          '</select>' +
          '</div>' +
          '</td>' +
          '<td>' +
          '<span class="checkSpeed unfinished" data-status="explain">未说明</span>' +
          '<input class="explainText" type="hidden" value="' + item.checkExplanation + '">' +
          '<input class="resolventText" type="hidden" value="' + item.checkingExplanation + '">' +
          '</td>' +
          '</tr>'
      });

      $('table tbody').html('').append(html)
      fetchData()
    }

    // 获取数据
    function fetchData() {
      app.findHiCheckByvSn({
        vSn: vSn
      }, function (res) {
        console.log(res)
        updateView(res)
      }, function (xhr, type, errorThrown) {
        //异常处理；
        console.log(type);
        mui.toast(type);
        if (type == 'timeout') {
          console.log("请求超时：请检查网络")
        } else {
          console.log('请求失败：' + type + '\n err:' + errorThrown);
        }
      })
    }

    // 更新视图 
    function updateView(res) {
      var data = res.checkResults;
      var $wireTr = $('table tbody tr');
      
      if(!res.check && data.length === 0) {
        return;
      }
      var a = res.check.checkPerson
      var b = res.check.checkingPerson

      console.log(a, b)
      $wireTr.each(function (i) {
        var x = data[i].checkExplanation
        var y = data[i].checkingExplanation

        $(this).attr('data-uuid', data[i].uuid)
        $(this).find('select.status').val(data[i].status);
        $(this).find('.explainText').val(x)
        $(this).find('.resolventText').val(y)

        if (!a) {
          $(this).find('.checkSpeed').html('未说明').addClass('unfinished').data('status', 'explain')
          status = 'explain'
          $('#openPopover').hide()
        } else if (!b) {
          if(x) {
            $(this).find('.checkSpeed').html('未解决').addClass('unfinished').data('status', 'resolvent') // 核对人
            $(this).find('select').addClass('unfinished')
          } else {
            $(this).find('.checkSpeed').html('完成').removeClass('unfinished').addClass('finished').data('status', 'resolvent') // 核对人
          }
          status = 'resolvent'
          $('#openPopover').show()
        } else {
          if(x && y) {
            $(this).find('.checkSpeed').html('查看').addClass('unfinished').data('status', '')
          } else if (x && !y) { 
            $(this).find('.checkSpeed').html('未完成').addClass('unfinished').data('status', 'resolvent') // 确认人 
            $(this).find('select').addClass('unfinished')
          } else {
            $(this).find('.checkSpeed').html('完成').removeClass('unfinished').addClass('finished').data('status', 'explain')
          }
          status = ''
          $('#openPopover').show() 
          $('#three_next').parent().hide()
        }


      })

      $('.checkPerson').html(res.check.checkPerson ? res.check.checkPerson : '')
      $('.checkTime').html(res.check.checkTime ? res.check.checkTime : '')
      $('.checkingPerson').html(res.check.checkingPerson ? res.check.checkingPerson : '')
      $('.checkingTime').html(res.check.checkingTime ? res.check.checkingTime : '')
    }

    // 添加说明
    $('table tbody').on('tap', '.checkSpeed', addExplanation)
    function addExplanation() {
      var _this = this;
      var explainText = $(_this).parents('tr').find('.explainText').val();
      var resolventText = $(_this).parents('tr').find('.resolventText').val();
      var trId = $(_this).parents('tr').data('uuid')

      if($(_this).html() == '完成') {
        mui.alert('该项目正常，无检查信息', '提示')
        return
      }
      mui.openWindow({
        url: 'vehicle-check-add-explain.html',
        id: 'vehicle-check-add-explain', //默认使用当前页面的url作为id
        styles: {
          top: '0px',
          // bottom: H,
          hardwareAccelerated: true
        }, //窗口参数
        extras: {
          H: H,
          viewId: viewId,
          trId: trId,
          status: status,
          explainText: explainText,
          resolventText: resolventText,
          confirmText: 'NOCONFIRM'
        } //自定义扩展参数
      })
      // window.removeEventListener('updateExplain', updateExplain, false)
      // window.addEventListener('updateExplain', updateExplain, false);

      // function updateExplain(evt) {
      //   evt.preventDefault()
      //   var data = evt.detail;
      //   mui.each(data, function(k, v) {
      //     console.log(k)
      //     if(k == 'html') {
      //       $(_this).html(v)
      //     } else {
      //       $(_this).addClass('unfinished').parents('tr').find('.'+k).val(v);
      //     }
      //   })
      //   $(_this).parents('tr').find('.status').val('N').addClass('unfinished')
      //   // status = $(_this).data('status')
      // }
    }

    document.removeEventListener('updateExplain', updateExplain, false)
    document.addEventListener('updateExplain', updateExplain, false);

    function updateExplain(evt) {
      evt.preventDefault()
      var data = evt.detail;
      mui.each(data, function(k, v) {
        console.log(k)
        if(k == 'html') {
          $('table tbody tr[data-uuid='+data.trId+']').find('.checkSpeed').html(v)
        } else {
          $('table tbody tr[data-uuid='+data.trId+']').find('.checkSpeed').addClass('unfinished').parents('tr').find('.'+k).val(v);
        }
      })
      $('table tbody tr[data-uuid='+data.trId+']').find('.status').val('N').addClass('unfinished')
      // status = $(_this).data('status')
    }
    
    // 提交数据
    $('#three_next').on('tap', toSubmit)
    function toSubmit() {
      if (submitLock) {
        mui.toast('请不要重复操作！')
        return;
      }
      submitLock = true;
      if (status == 'explain') {
        stateArr = submitArr;
      } else if (status == 'resolvent') {
        stateArr = updateArr;
      }
      submitData()
    }

    function submitData() {
      var $wireTr = $('table tbody tr');
      var HIResults = [];
      var data = {};
      var pitem = '';

      $wireTr.each(function (i) {
        if ($(this).find('.pitem').length > 0) {
          pitem = $(this).find('.pitem').html()
        }
        var obj = {
          'checkExplanation': $(this).find('.explainText').val(),
          'checkingExplanation': $(this).find('.resolventText').val(),
          'pitem': pitem,
          'item': $(this).find('.item').length > 0 ? $(this).find('.item').html() : '',
          'status': $(this).find('.status').val(),
          'vSn': vSn,
          'uuid': $(this).attr('data-uuid') ? $(this).attr('data-uuid') : ''
        }

        // if ((obj.status == 'Y' && obj.checkExplanation != '') || (obj.status == 'N' && obj.checkExplanation == '')) {
        //   mui.alert('"' + obj.item + '"未添加说明', '提示')
        //   submitLock = false;
        //   $(this).find('.status').css('color', '#ff3a31')
        //   return;
        // }
        // if ((obj.status == 'Y' && obj.checkingExplanation != '') || (obj.status == 'N' && obj.checkingExplanation == '')) {
        //   mui.alert('"' + obj.item + '未添加解决方法', '提示')
        //   submitLock = false;
        //   $(this).find('.status').css('color', '#ff3a31')
        //   return;
        // }

        HIResults.push(obj)
      })

      data = {
        vSn: vSn,
        HIResults: HIResults
      }
      console.log(data);
      // return;
      app[stateArr[0]](data, function (res) {
        console.log(res);
        // mui.toast(res.msg);
        if (res.ret) {
          mui.toast(res.msg);
          // setTimeout(function() {
          submitLock = false;
          mui.back()
          // mui.fire(view, 'update', null)
          // }, 100);

        } else {
          mui.toast('线束检查失败')
          submitLock = false;
        }
      })

    }

    // 修改
    $('#popover').on('tap', 'a', function () {
      var str = $(this).html()
      mui('.mui-popover').popover('hide');
      if(str == '修改检查项') {
        if (isRevising) {
          mui.alert('请先完成之前的修改操作', '提示')
          return;
        }
        isRevising = true
        status = 'explain'
        $(this).html('取消修改检查项')
        $('#three_next').html('确认修改').parent().show()
        $('table tbody tr').each(function(i) {
          var text = $(this).find('.checkSpeed').html()
          $(this).find('.checkSpeed').html('修改')
        })
      } else if (str == '修改核对项') {
        if (isRevising) {
          mui.alert('请先完成之前的修改操作', '提示')
          return;
        }
        isRevising = true
        status = 'resolvent'
        $(this).html('取消修改核对项')
        $('#three_next').html('确认修改').parent().show()
        
        $('table tbody tr').each(function(i) {
          var text = $(this).find('.checkSpeed').html()
          if(text == '未完成' || text == '查看') $(this).find('.checkSpeed').html('修改')
        })
      } else if(str == '取消修改检查项') {
        isRevising = false
        status = 'explain'
        $(this).html('修改检查项')
        $('#three_next').parent().hide()
        _init()
      } else if (str == '取消修改核对项') {
        isRevising = false
        status = 'resolvent'
        $(this).html('修改核对项')
        $('#three_next').parent().hide()
        _init()
      }
    })

    document.addEventListener('update', function () {
      fetchData()
    })
  </script>
</body>

</html>