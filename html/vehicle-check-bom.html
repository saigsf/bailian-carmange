<!doctype html>
<html>

<head>
  <meta charset="UTF-8">
  <title>bom零部件检查</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-status-bar-style" content="black">
  <!--mui样式应用-->
  <link href="../css/mui.min.css" rel="stylesheet" />
  <!--自定义图标样式-->
  <link rel="stylesheet" type="text/css" href="../css/style-icon.css" />
  <!--自定义页面样式-->
  <link rel="stylesheet" type="text/css" href="../css/style-common.css" />
  <!--独立样式-->
  <style type="text/css">
    .explain,
    .resolvent {
      font-size: 24px;
    }

    .mui-popover {
      width: 140px;
    }

    .info-operator {
      flex-direction: column;
    }

    .info-operator-item {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }

    .info-operator-item p {
      width: 50%;
      margin: 0;
    }

    .info-operator-item span {
      display: inline;
    }

    .no-data {
      height: 100%;
      z-index: 999;
      background-color: #fff;
    }

    .no-data p {
      top: 40%
    }
    .select-container select {
      padding-left: 10px;
      padding-right: 0;
    }
    table {
      margin-top: 10px;
    }
    #openPopover {
      display: none
    }
  </style>
</head>

<body>
  <header class="mui-bar mui-bar-nav">
    <a class="mui-action-back icon icon-back mui-pull-left"></a>
    <h1 class="mui-title">bom零部件查验</h1>
    <a href="#popover" id="openPopover" class="mui-btn mui-btn-outlined mui-pull-right">修改</a>
  </header>
  <!--页面主内容区开始-->
  <div class="mui-content mui-scroll-wrapper">
    <div class="mui-scroll">
      <table>
        <thead>
          <tr>
            <td width="40%">零部件名称</td>
            <td width="25%">零部件号</td>
            <td width="15%">状态</td>
            <td width="30%">检查进度</td>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="info-operator">
        <div class="info-operator-item">
          <p>
            <span>申请人：</span>
            <span class="applyPerson"></span>
          </p>
          <p>
            <span>申请日期：</span>
            <span class="applyTime"></span>
          </p>

        </div>
        <div class="info-operator-item">
          <p>
            <span>检查人：</span>
            <span class="checkPerson"></span>
          </p>
          <p>
            <span>检查日期：</span>
            <span class="checkTime"></span>
          </p>

        </div>
        <div class="info-operator-item">
          <p>
            <span>核对人：</span>
            <span class="checkingPerson"></span>
          </p>
          <p>
            <span>核对日期：</span>
            <span class="checkingTime"></span>
          </p>
        </div>
      </div>
      <div class="btn-wrapper">
        <div class="btn btn-blue" id="four_next">提交</div>
      </div>
    </div>
    <div class="no-data" id="no-data">
      <p>您还没有申请bom，请先申请bom</p>
    </div>
  </div>
  <!--页面主内容区结束-->

  <div id="popover" class="mui-popover">
    <ul class="mui-table-view">
      <li class="mui-table-view-cell">
        <a href="#">修改检查项</a>
      </li>
      <li class="mui-table-view-cell">
        <a href="#">修改核对项</a>
      </li>
    </ul>
  </div>
  <!-- jquery -->
  <script src="../js/lib/jquery.min.js"></script>
  <!-- mui -->
  <script src="../js/mui.min.js"></script>
  <!-- config 配置项 -->
  <script src="../js/app/config.js"></script>
  <!-- app 数据获取 -->
  <script src="../js/app/app.js"></script>
  <!-- 当前页面js -->
  <script type="text/javascript">
    var H = null;
    var self = null;
    var view = null;
    var vSn = '2018-512';
    var status = 'explain'
    var viewId = null;
    var state = null;
    var stateArr = [];
    var submitArr = ['addEmsAndBomCheck'];
    var updateArr = ['updateEmsAndBomCheckByCar'];
    var canChecked = true; // 核对
    var canInspect = true; // 检查

    var submitLock = false; // 提交保护
    var hasCheck = false;

    var isRevising = false; // 修改索订    

    mui.init();
    //初始化单页的区域滚动
    mui('.mui-scroll-wrapper').scroll();
    mui.plusReady(function () {
      handsetAdaption();
      $('.mui-scroll').css('min-height', $('.mui-content').height())
      self = plus.webview.currentWebview();
      view = plus.webview.getWebviewById(self.prevId)
      viewId = self.id;
      H = self.H;
      vSn = self.vSn;
      state = app.getState();
      fetchData();
      // submitData();
    })

    function handsetAdaption() {
      if (plus.device.model === 'iPhoneX') {
        //页面样式重置
        $('header').css({
          'height': '88px',
          'paddingTop': '40px'
        });
        $('.mui-bar-nav~.mui-content').css({
          'paddingTop': '88px'
        })
      }
      plus.webview.currentWebview().setStyle({
        softinputMode: "adjustResize" // 弹出软键盘时自动改变webview的高度
      });
    }

    // 获取数据
    fetchData()

    function fetchData() {
      app.findEmsAndBomCheckByvSn({
        vSn: vSn
      }, function (res) {
        console.log(JSON.stringify(res.check))
        console.log(JSON.stringify(res.checkResults))
        updateView(res)
      }, function (xhr, type, errorThrown) {
        //异常处理；
        console.log(type);
        mui.toast(type);
        if (type == 'timeout') {
          console.log("请求超时：请检查网络")
        } else {
          console.log('请求失败：' + type + '\n err:' + errorThrown);
        }
      })
    }

    // 视图更新
    function updateView(res) {
      var data = res.checkResults;
      var html = '';
      if(!res.check && data.length === 0) {
        return;
      }
      var a = res.check.checkPerson
      var b = res.check.checkingPerson

      console.log(a, b)

      mui.each(data, function (k, v) {
        var x = v.checkExplanation
        var y = v.checkingExplanation
        console.log(x)
        html += '<tr data-uuid="' + v.uuid + '">' +
          '<td class="bomName">' + v.bomName + '</td>' +
          '<td class="bomNum">' + v.bomNum + '</td>' +
          '<td>' +
          '<div class="select-container">' +
          '<select name="status" class="status" value="'+v.status+'">' +
          '<option value="Y">是</option>' +
          '<option value="N">否</option>' +
          '<option value="NA">NA</option>' +
          '</select>' +
          '</div>' +
          '</td>' +
          '<td>'

        if (!a) {
          html += '<span class="checkSpeed unfinished" data-status="explain">未说明</span>'
          status = 'explain'
          $('#openPopover').hide()
          $('#four_next').parent().show()
        } else if (!b) {
          if(x) {
            html += '<span class="checkSpeed unfinished" data-status="resolvent">未解决</span>' // 核对人
          } else {
            html += '<span class="checkSpeed finished" data-status="resolvent">完成</span>'  // 核对人
          }
          status = 'resolvent'
          $('#openPopover').show()
          $('#four_next').parent().show()
        } else {
          if(x && y) {
            html += '<span class="checkSpeed" data-status="">查看</span>'
          } else if (x && !y) { 
            html += '<span class="checkSpeed unfinished" data-status="resolvent">未完成</span>'
          } else {
            html += '<span class="checkSpeed finished" data-status="explain">完成</span>'
          }
          status = ''
          $('#openPopover').show()
          $('#four_next').parent().hide()
        }
          
        html += '<input class="explainText" type="hidden" value="' + (v.checkExplanation?v.checkExplanation:'') + '">' +
          '<input class="resolventText" type="hidden" value="' + (v.checkingExplanation?v.checkingExplanation:'') + '">' +
          '</td>' +
          '</tr>'
      })

      $('table tbody').html(html);

      $('.applyPerson').html(res.check.applyPerson ? res.check.applyPerson : '')
      $('.applyTime').html(res.check.applyTime ? res.check.applyTime : '')
      $('.checkPerson').html(res.check.checkPerson ? res.check.checkPerson : '')
      $('.checkTime').html(res.check.checkTime ? res.check.checkTime : '')
      $('.checkingPerson').html(res.check.checkingPerson ? res.check.checkingPerson : '')
      $('.checkingTime').html(res.check.checkingTime ? res.check.checkingTime : '')


      var $bomTr = $('table tbody tr');
    }

    // 添加说明
    $('table tbody').on('tap', '.checkSpeed', addExplanation)
    function addExplanation() {
      var _this = this;
      var explainText = $(_this).parents('tr').find('.explainText').val();
      var resolventText = $(_this).parents('tr').find('.resolventText').val();
      var trId = $(_this).parents('tr').data('uuid')
      if($(_this).html() == '完成') {
        mui.alert('该项目正常，无检查信息', '提示')
        return
      }
      mui.openWindow({
        url: 'vehicle-check-add-explain.html',
        id: 'vehicle-check-add-explain', //默认使用当前页面的url作为id
        styles: {
          top: '0px',
          // bottom: H,
          hardwareAccelerated: true
        }, //窗口参数
        extras: {
          H: H,
          viewId: viewId,
          trId: trId,
          status: status,
          explainText: explainText,
          resolventText: resolventText,
          confirmText: 'NOCONFIRM'
        } //自定义扩展参数
      })
      
    }
    document.removeEventListener('updateExplain', updateExplain, false)
    document.addEventListener('updateExplain', updateExplain, false);

    function updateExplain(evt) {
      evt.preventDefault()
      var data = evt.detail;
      mui.each(data, function(k, v) {
        console.log(k)
        if(k == 'html') {
          $('table tbody tr[data-uuid='+data.trId+']').find('.checkSpeed').html(v)
        } else {
          $('table tbody tr[data-uuid='+data.trId+']').find('.checkSpeed').addClass('unfinished').parents('tr').find('.'+k).val(v);
        }
      })
      $('table tbody tr[data-uuid='+data.trId+']').find('.status').val('N').addClass('unfinished')
      // status = $(_this).data('status')
    }
    
    // 提交数据
    $('#four_next').on('tap', toSubmit)

    function toSubmit() {
      if (submitLock) {
        mui.toast('请不要重复操作！')
        return;
      }
      submitLock = true;
      if (status == 'explain') {
        stateArr = submitArr;
      } else if (status == 'resolvent') {
        stateArr = updateArr;
      }
      submitData()
    }

    function submitData() {
      // bom检查
      var $bomTr = $('table tbody tr');
      if ($bomTr.length == 0) {
        mui.alert('您还没有进行bom申请，请先去bom申请', '提示');
        submitLock = false;
        return;
      }

      var emsAndBomCheckResults = [];
      var data = {};

      $bomTr.each(function (i) {
        var _this = this
        var obj = {
          'vSn': vSn,
          'uuid': $(_this).attr('data-uuid') ? $(_this).attr('data-uuid') : '',
          'bomName': $(_this).find('.bomName').html(),
          'bomNum': $(_this).find('.bomNum').html(),
          'status': $(_this).find('.status').val(),
          'checkExplanation': $(_this).find('.explainText').val(),
          'checkingExplanation': $(_this).find('.resolventText').val(),
        }
        // if (obj.status == 'N' && obj.checkExplanation == '') {
        //   $(this).find('.status').css('color', '#ff3a31')
        // }
        emsAndBomCheckResults.push(obj)
      });

      // mui.each(emsAndBomCheckResults, function (k, v) {
      //   if (v.status == 'N' && v.checkExplanation == '') {
      //     mui.alert('"' + v.item + '"未添加说明', '提示')
      //     submitLock = false;
      //     return;
      //   }
      // })

      data = {
        vSn: vSn,
        emsAndBomCheckResults: emsAndBomCheckResults
      }
      console.log(JSON.stringify(data))
      // return;
      // console.log(stateArr[0])
      app[stateArr[0]](data, function (res) {
        console.log(res.msg)

        if (res.ret) {
          mui.toast(res.msg);
          // setTimeout(function() {
          submitLock = false;
          mui.back();
          // }, 100);
        } else {
          submitLock = false;
          mui.toast(res.msg);
        }
      })

    }
    $('#popover').on('tap', 'a', function () {
      var str = $(this).html()
      mui('.mui-popover').popover('hide');
      if(str == '修改检查项') {
        if (isRevising) {
          mui.alert('请先完成之前的修改操作', '提示')
          return;
        }
        isRevising = true
        status = 'explain'
        $(this).html('取消修改检查项')
        $('#four_next').html('确认修改').parent().show()
        $('table tbody tr').each(function(i) {
          var text = $(this).find('.checkSpeed').html()
          $(this).find('.checkSpeed').html('修改')
        })
      } else if (str == '修改核对项') {
        if (isRevising) {
          mui.alert('请先完成之前的修改操作', '提示')
          return;
        }
        isRevising = true
        status = 'resolvent'
        $(this).html('取消修改核对项')
        $('#four_next').html('确认修改').parent().show()
        
        $('table tbody tr').each(function(i) {
          var text = $(this).find('.checkSpeed').html()
          if(text == '未完成' || text == '查看') $(this).find('.checkSpeed').html('修改')
        })
      } else if(str == '取消修改检查项') {
        isRevising = false
        status = 'explain'
        $(this).html('修改检查项')
        $('#four_next').parent().hide()
        _init()
      } else if (str == '取消修改核对项') {
        isRevising = false
        status = 'resolvent'
        $(this).html('修改核对项')
        $('#four_next').parent().hide()
        _init()
      }
    })


    document.addEventListener('update', function () {
      fetchData()
    })
  </script>
</body>

</html>