<!doctype html>
<html>

<head>
  <meta charset="UTF-8">
  <title></title>
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-status-bar-style" content="black">
  <!-- 地图样式 -->
  <link rel="stylesheet" href="http://cache.amap.com/lbs/static/main1119.css" />
  <!--mui样式应用-->
  <link href="../css/mui.min.css" rel="stylesheet" />
  <!--自定义图标样式-->
  <link rel="stylesheet" type="text/css" href="../css/style-icon.css" />
  <!--自定义页面样式-->
  <link rel="stylesheet" type="text/css" href="../css/style-common.css" />
  <!--独立样式-->
  <style type="text/css">
    html,
    body {
      height: 100%;
      overflow: hidden;
    }

    .map {
      height: 80%;
    }

    .search-wrapper {
      position: fixed;
      top: 40px;
      left: 20px;
      height: 44px;
      background-color: rgba(255, 255, 255, .9);
      z-index: 999;
      width: 70%;
      border: none;
      box-shadow: 0 4px 9px rgba(0, 0, 0, 0.25);
      transition: all .7s;
    }

    .search-wrapper input {
      font-size: 14px;
    }

    .top-mark {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 20px;
      z-index: 998;
      background: url(../img/common/md/top_mark@2x.png) no-repeat center;
      background-size: cover;
    }

    .mui-btn {
      position: fixed;
      top: 40px;
      right: 20px;
      z-index: 999;
      width: 44px;
      height: 44px;
      line-height: 44px;
      padding: 0;
      border-radius: 50%;
      border: none;
      box-shadow: 0 2px 6px rgba(40, 133, 207, .7)
    }

    .vehicle-info {
      height: 20%;
      width: 100%;
      padding: 20px;
      margin: 0;
      border-radius: 0;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3)
    }

    .vehicle-info p {
      color: #333;
    }

    .license {
      display: inline-block;
      padding: 5px 12px;
      border: 1px solid #2885cf;
      border-radius: 3px;
      color: #2885cf;
      margin-right: 20px;
      font-size: 16px;
    }

    .carStatus {
      display: inline-block;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      vertical-align: middle;
    }

    .carStatus.red {
      background-color: red;
    }

    .carStatus.gray {
      background-color: gray;
    }

    .carStatus.yellow {
      background-color: yellow;
    }

    .mui-pull-left {
      width: 40%;
      height: 60px;
      /* text-align: center; */
      line-height: 60px;
    }

    .mui-pull-left span {
      font-size: 18px;
      padding: 0 2px;
    }

    .mui-pull-right {
      width: 60%;
      height: 60px;
    }

    .car {
      position: absolute;
      top: -20px;
      right: 20px;
      width: 100px;
      z-index: 998;
    }

    .car img {
      width: 100%;
    }

    .amap-logo,
    .amap-copyright {
      display: none !important;
    }

    .icon-search {
      width: 16px;
      height: 16px;
    }

    .result {
      position: fixed;
      top: 85px;
      left: 20px;
      width: 90%;
      /* padding-top: 20px; */
      background-color: #fff;
      z-index: 999;
      display: none;
    }

    .result-item {
      height: 44px;
      line-height: 34px;
      padding: 5px 20px;
      color: #999;
    }

    .result-item span {
      color: #000;
    }

    .result-item:not(:last-of-type) {
      border-bottom: 1px solid #eee;
    }

    .result-item:after {
      content: "";
      width: 10px;
      height: 100%;
      display: block;
      background: url(../img/common/md/icon_arraw_right_top@2x.png) no-repeat center;
      background-size: contain;
      float: right;
    }

    .no-data {
      background-image: url(../img/common/md/no_mapdata.png);
      background-size: 40%;
      background-position: center 10%;
      background-color: #fff;
      display: block;
    }

    .no-data p {
      color: #999;
      top: 50%;
    }

    .car {
      display: none;
    }
  </style>
</head>

<body>

  <!-- 主页面内容容器 -->
  <div class="mui-content">
    <div class="top-mark"></div>
    <div class="search-wrapper">

      <div class="search-btn">
        <i class="icon-search icon"></i>
      </div>
      <div class="search-text">
        <input type="text" placeholder="请输入车辆编号" id="search">
      </div>
      <div class="clear-btn" id="clear-btn"></div>
    </div>

    <div class="mui-btn mui-btn-blue" id="track">轨迹</div>

    <div class="result">
      <!-- <div class="result-item">2018ICECTC001</div> -->
    </div>

    <div class="map" id="map"></div>
    <div class="vehicle-info">
      <p>
        <span class="license" id="licenseNo">未选择</span>
        <span class="carStatus red"></span>
        <span class="carType " id="vCarType">-</span>
      </p>
      <div class="mui-pull-left">
        车速
        <span id="speed">0</span>
        km/h
      </div>
      <div class="mui-pull-right">
        <p>
          <span>驾驶员：</span>
          <span class="driverName" id="driverName">-</span>
        </p>
        <p>
          <span>德尔福编号：</span>
          <span class="vSn" id="vSn">-</span>
        </p>
      </div>
      <div class="car">
        <img src="../img/common/md/home_car@2x.png" alt="">
      </div>
      <div class="no-data" id="no-data">
        <p>请先搜索或选择车辆</p>
      </div>
    </div>
  </div>
  
  <script src="../js/lib/jquery.min.js"></script>
  <!-- mui -->
  <script src="../js/mui.min.js"></script>
  <!-- common.js -->
  <script src="../js/app/common.js"></script>
  <!-- config 配置项 -->
  <script src="../js/app/config.js"></script>
  <!-- app 数据获取 -->
  <script src="../js/app/app.js"></script>
  <!-- 百度地图api -->
  <script src="http://webapi.amap.com/maps?v=1.4.6&key=ffc8503b4c8647c3753679c5e95278a5&plugin=AMap.MarkerClusterer"></script>
  <!-- <script type="text/javascript" src="http://cache.amap.com/lbs/static/addToolbar.js"></script> -->
  <!-- <script type="text/javascript" src="http://webapi.amap.com/demos/js/liteToolbar.js"></script> -->
  <script src="http://a.amap.com/jsapi_demos/static/china.js"></script>
  <!--多点聚合-->
  <!-- 当前页面js -->
  <script>
    (function () {
      mui.init({
        swipeBack: true //启用右滑关闭功能
      });
      // 全局变量
      var flag = true;
      var bottom = '-70px';
      var H = null;
      var self = null;
      var vSn = '2018ICECTC001';
      var pageTrack = null;
      var map = new AMap.Map("map", {
        resizeEnable: false,
        center: [105, 34],
        zoom: 5
      });
      // 创建一个 Icon
      var icon = new AMap.Icon({
        // 图标尺寸
        size: new AMap.Size(35, 35),
        // 图标的取图地址
        image: '../img/car.png',
        // 图标所用图片大小
        imageSize: new AMap.Size(35, 35),
        // 图标取图偏移量
        imageOffset: new AMap.Pixel(-0, -0)
      });

      /* ================批量添加标记点================== */

      var cluster = [] // 聚合点
      var markers = [] // 预添加标记点
      var mapMarkers = [] // 添加到地图上的标记点
      var timer = null // 定时刷新
      // 获取标记点位置
      function getMarkers(res) {
        markers = []
        // for (let i = 0; i < res.length; i++) {
        //   var lot = res[i].longitude
        //   var lat = res[i].latitude
        //   markers.push({
        //     position: [lot, lat],
        //     icon: icon,
        //     angle: res[i].towards,
        //     data: res[i]
        //   })
        // }
        res.forEach(function(item, i) {
          console.log(item)
          var lot = item.longitude
          var lat = item.latitude
          markers.push({
            position: [lot, lat],
            icon: icon,
            angle: item.towards,
            data: item
          })
        });
        if (mapMarkers.length === 0 || mapMarkers.length != markers.length) {
          addMarkers()
        } else {
          resetMarkers()
        }
        
      }

      // 添加标记点
      function addMarkers() {
        if (markers.length === 0) {
          return
        }
        clearMarkers()
        markers.forEach(function (marker) {
          var mapMarker = new AMap.Marker({
            map: map,
            icon: marker.icon,
            position: [marker.position[0], marker.position[1]],
            offset: new AMap.Pixel(-15, -15),
            angle: marker.angle,
            autoRotation: true
          });
          // 添加标记点信息
          mapMarker.data = marker.data

          // 添加点击事件
          mapMarker.on('click', function (e) {
            var data = e.target.data
            $('#no-data').hide()
            $('.car').show()
            mui.each(data, function (k, v) {
              $('#' + k).html(v ? v : '-')
            })
          })

          mapMarkers.push(mapMarker)
        })

        map.setFitView()
        addCluster()
      }

      // 更新标记点位置
      function resetMarkers() {
        // console.log(mapMarkers)
        mapMarkers.forEach(function(mapMarker, i) {
          mapMarker.data = markers[i].data
          mapMarker.setPosition(markers[i].position)
          mapMarker.setAngle(markers[i].angle)
        });
      }

      // 删除标记点
      function clearMarkers() {
        mapMarkers.forEach(function (mapMarker) {
          cluster.removeMarker(mapMarker)
        });
        mapMarkers = []
        // clearInterval(timer)
      }

      // 添加聚合
      function addCluster() {
        
        cluster = new AMap.MarkerClusterer(map, mapMarkers, {
          gridSize: 30,
          maxZoom: 18
        });
      }
      // 获取数据
      function getAllCar() {
        app.allcar({}, function (res) {
          res = JSON.parse(res)
          // console.log(res)
          if (res.ret == false) {
            alert(res.msg);
            return;
          }
          getMarkers(res)
        }, function (err) {

        })
      }

      getAllCar()
      timer = setInterval(function () {
        getAllCar()
      }, 5000)

      mui.plusReady(function () {
        // plus准备好后执行H5
        handsetAdaption()
        // 获取当前视图
        self = plus.webview.currentWebview();
        // 获取传递参数
        H = self.H;

        pageTrack = mui.preload({
          url: 'home-track.html',
          id: 'home-track',
          styles: {
            top: '0', //mui标题栏默认高度为45px；
            bottom: '0' //默认为0px，可不定义；
          },
          extras: {
            H: H,
            prevId: self.id
          }
        })

        // addEvent()
      })

      // 手机适配方法
      function handsetAdaption() {
        // 更改顶部导航栏高度
        if (plus.device.model === 'iPhoneX') {
          // 页面样式重置
          $('header').css({
            'height': '88px',
            'paddingTop': '40px'
          });
          $('.search-wrapper').css({
            'top': '54px'
          })
          $('.result').css({
            'top': '99px'
          })
          $('.mui-btn').css({
            'top': '54px'
          })
          $('.mui-bar-nav~.mui-content').css({
            'paddingTop': '88px'
          })

          $('.top-mark').height(44)
        }

        // 更改状态栏颜色
        // plus.navigator.setStatusBarStyle("dark");
        // 弹出软键盘时自动改变webview的高度
        //  plus.webview.currentWebview().setStyle({
        //    softinputMode: "adjustResize"
        //  });

      }

      addEvent()

      function addEvent() {
        $('#track').on('tap', function () {
          clearInterval(timer)
          pageTrack.show('slide-in-right')
          // mui.openWindow({
          // 	url: 'home-track.html',
          // 	id: 'home-track',
          // 	styles: {
          // 		top: '0',//mui标题栏默认高度为45px；
          // 		bottom: H//默认为0px，可不定义；
          // 	},
          // 	extras: {
          // 		H: H,
          // 		prevId: self.id
          // 	}
          // })

          mui.fire(pageTrack, 'statusBar', null)
        });
        // 搜索框获得焦点
        $('#search').focus(function () {
          $('#track').fadeOut(500).prev().css({
            'width': '90%',
            'backgroundColor': 'rgba(255, 255, 255, 1)',
            'borderRadius': '0'
          });
          $('#clear-btn').show();
        })
        // 搜索框失去焦点
        $('#search').blur(function () {
          $('#track').prev().css({
            'width': '70%',
            'backgroundColor': 'rgba(255, 255, 255, .9)',
            'borderRadius': '34px'
          });
          $('.result').hide()
          $('#clear-btn').hide();
          $(this).val('')
          setTimeout(function () {
            $('#track').show()
          }, 500);

        })

        // 搜索框键盘按下事件
        $('#search').on('keyup', function () {
          // 车辆编号模糊查询
          vSn = $(this).val();
          // console.log($(this).val())
          var reg = new RegExp(vSn, 'g');

          app.likevSn({vSn: vSn}, function (res) {
            console.log(res)
            // res = ['2018ICECTC001', '2018ICECTC002', '2018ICECTC003']
            var html = '';
            mui.each(res, function (k, v) {
              html += '<div class="result-item" data-vSn="' + v + '">' + v.replace(reg, '<span>' + vSn +
                  '</span>') +
                '</div>'
            })

            $('.result').show().html(html)
          }, function (xhr, type, errorThrown) {
            //异常处理；
            console.log(type);
            mui.toast(type);
            if (type == 'timeout') {
              console.log("请求超时：请检查网络")
            } else {
              console.log('请求失败：' + type + '\n err:' + errorThrown);
            }
          })
        })

        // 取消搜索
        $('#clear-btn').on('tap', function () {
          $('#search')[0].blur()
        })

        $('.result').on('tap', function (e) {
          $('#search').blur()
          vSn = $(e.target).attr('data-vSn')

          app.carData({
            vSn: vSn
          }, function (res) {
            res = JSON.parse(res);
            console.log(res);
            if(res == null || res == '' || !(res.latitude && res.longitude)) {
              mui.toast('沒有搜索結果')
              return;
            }
            // 显示车辆信息
            $('#no-data').hide()
            $('.car').show()
            mui.each(res, function (k, v) {
              $('#' + k).html(v ? v : '-')
            })
            // 清除聚合标记
            clearMarkers()
            // 清除定时器
            clearInterval(timer)
            // 添加标记点
            getMarkers([res])
            // 10秒后重启定时器
            setTimeout(function() {
              clearInterval(timer)
              timer = setInterval(function () {
                getAllCar()
              }, 5000)
            }, 5000)

          }, function (xhr, type, errorThrown) {
            //异常处理；
            console.log(type);
            mui.toast(type);
            if (type == 'timeout') {
              console.log("请求超时：请检查网络")
            } else {
              console.log('请求失败：' + type + '\n err:' + errorThrown);
            }
          });

        })

      }

      // 状态栏颜色更改
      document.addEventListener('statusBar', function (e) {
        // plus.navigator.setStatusBarStyle('light');
        getAllCar()
        clearInterval(timer)
        timer = setInterval(function () {
          getAllCar()
        }, 5000)
      })


      document.addEventListener('clearTimer', function () {
        clearInterval(timer)
      })



      // 绑定事件
      var listener = AMap.event.addListener(map, "tap", function (ev) {
        // DOM 被点击时触发，ev 为原生事件
        console.log(ev)
        $('#no-data').show()
        $('.car').hide()
        map.setZoom(10)
      });
    })()
  </script>
</body>

</html>