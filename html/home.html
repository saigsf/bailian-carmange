<!doctype html>
<html>

<head>
	<meta charset="UTF-8">
	<title></title>
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-status-bar-style" content="black">
	<!--mui样式应用-->
	<link href="../css/mui.min.css" rel="stylesheet" />
	<!--自定义图标样式-->
	<link rel="stylesheet" type="text/css" href="../css/style-icon.css" />
	<!--自定义页面样式-->
	<link rel="stylesheet" type="text/css" href="../css/style-common.css" />
	<!--独立样式-->
	<style type="text/css">
		html,
		body {
			height: 100%;
			overflow: hidden;
		}

		.mui-content {
			height: 100%;
		}

		.mui-segmented-control {
			position: absolute;
			top: 108px;
			left: 50%;
			transform: translateX(-50%);
			width: 80%;
			border-radius: 40px;
			border-color: #2885CF;
			z-index: 1;
			background-color: #fff;
		}

		.mui-segmented-control .mui-control-item {
			color: #2885CF;
			border-color: #2885CF;
			border-left: 1px solid #2885CF;
		}

		.mui-segmented-control .mui-control-item.mui-active {
			background-color: #2885CF;
			border-color: #2885CF;
			border-left: 1px solid #2885CF;
		}

		.mui-control-content {
			height: 100%;
			width: 100%;
		}

		.bottom-search {
			padding-top: 15px;
			position: fixed;
			left: 0;
			bottom: 0;
			background-image: url(../img/common/background_ellipse.png);
			background-position: top center;
			background-size: 150%;
			background-repeat: no-repeat;
			width: 100%;
			transition: all ease-in-out .7s;
			z-index: 2;
		}

		.mui-btn.mui-btn-block.mui-btn-outlined {
			font-size: 24px;
			padding: 10px 0;
			border: none;
			margin-bottom: 0;
		}

		.mui-input-row.mui-search {
			width: 90%;
			margin: 20px auto;
			border: 1px solid #ccc;
			border-radius: 40px;
		}

		.mui-input-row.mui-search input[type=search] {
			/* height: 34px; */
			background-color: rgba(255, 255, 255, .7);
			margin: 0;

		}



		.mui-btn .mui-icon {
			padding: 10px;
			font-weight: bold
		}

		.item1-map,
		.item2-map {
			height: 100%;
		}

		.search-wrapper {
			width: 90%;
			margin: 20px auto;
		}

		.date-container {
			display: flex;
			justify-content: space-between;
			align-items: center;
			width: 90%;
			margin: auto;
			margin-top: 20px;
			display: none;
		}

		.date-wrapper {
			width: 45%;
		}
	</style>
</head>

<body>
	<!-- <header class="mui-bar mui-bar-nav">
		<a class="mui-action-back icon icon-back mui-pull-left"></a>
		<h1 class="mui-title">车辆轨迹</h1>
		<a class="search mui-pull-right" id="search">
			<i class="icon icon-search-white"></i>
		</a>
	</header> -->
	<!-- 主页面内容容器 -->
	<div class="mui-content">
		<div class="mui-segmented-control">
			<a class="mui-control-item mui-active" href="#item2">实时监控</a>
			<a class="mui-control-item" href="#item1">车辆轨迹</a>
		</div>

		<div class="mui-control-content mui-active" id="item2">
			<div class="item2-mask"></div>
			<div class="item2-map" id="item2-map"></div>
		</div>
		<div class="mui-control-content" id="item1">
			<div class="item1-mask"></div>
			<div class="item1-map" id="item1-map"></div>
		</div>


		<!--车辆信息弹框-->
		<div id="popover" class="mui-popover">
			<div class="vehicle-info"> </div>
		</div>

		<!--底部搜索-->
		<div class="bottom-search">
			<div class="mui-btn mui-btn-block mui-btn-outlined">
				<i class="icon icon-arrowdown" id="btn"></i>
			</div>
			<div class="date-container">
				<div class="date-wrapper">
					<!--<label>开始</label>-->
					<div class="date-text" id="start_date_box">
						<input type="text" id="start_date" readonly placeholder="请选择起始时间">
						<div class="date-icon">
							<i class="icon icon-date"></i>
						</div>
					</div>
				</div>
				<div class="date-wrapper">
					<!--<label>结束</label>-->
					<div class="date-text" id="end_date_box">
						<input type="text" id="end_date" readonly placeholder="请选择终止时间">
						<div class="date-icon">
							<i class="icon icon-date"></i>
						</div>
					</div>
				</div>

			</div>

			<!-- <div class="search-wrapper">
				<div class="search-text">
					<input type="search" class="current-input" id="current_input" placeholder="请输入车辆编号">
					<span class="clear-btn"></span>
				</div>
				<div class="search-btn">
					<i class="icon icon-search"></i>
				</div>
			</div> -->
			<form>
				<div class="mui-input-row mui-search">
					<input type="search" class="mui-input-clear" placeholder="请输入车辆编号">
				</div>
			</form>


		</div>
	</div>
	<!-- jquery -->
	<script src="../js/lib/jquery.min.js"></script>
	<!-- mui -->
	<script src="../js/mui.min.js"></script>
	<!-- config 配置项 -->
	<script src="../js/app/config.js"></script>
	<!-- app 数据获取 -->
	<script src="../js/app/app.js"></script>
	<!-- 百度地图api -->
	<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=qIVEmOSVWxsby5OEWwm6UIbEfHKEDcZz"></script>
	<!--多点聚合-->
	<script type="text/javascript" src="http://api.map.baidu.com/library/TextIconOverlay/1.2/src/TextIconOverlay_min.js"></script>
	<script type="text/javascript" src="http://api.map.baidu.com/library/MarkerClusterer/1.2/src/MarkerClusterer_min.js"></script>
	<!-- 当前页面js -->
	<script>
		(function () {
			mui.init({
				swipeBack: true //启用右滑关闭功能
			});
			// 全局变量
			var flag = true;
			var bottom = '-70px';
			var H = null;
			var self = null;
			var vSn = '2018ICECTC006';
			
			// 百度地图API功能	
			var map1 = new BMap.Map("item1-map");
			var map2 = new BMap.Map("item2-map");
			var myIcon = new BMap.Icon("../img/2222@3x.png", new BMap.Size(28, 64));

			mui.plusReady(function () {
				// plus准备好后执行H5
				handsetAdaption()
				// 获取当前视图
				self = plus.webview.currentWebview();
				// 获取传递参数
				H = self.H;

				getLocation();
				addEvent()
			})

			// 手机适配方法
			function handsetAdaption() {
				// 更改顶部导航栏高度
				if (plus.device.model === 'iPhoneX') {
					// 页面样式重置
					$('header').css({
						'height': '88px',
						'paddingTop': '40px'
					});
					$('.mui-bar-nav~.mui-content').css({
						'paddingTop': '88px'
					})
				}

				// 更改状态栏颜色
				// plus.navigator.setStatusBarStyle("light");
				// 弹出软键盘时自动改变webview的高度
				//  plus.webview.currentWebview().setStyle({
				//    softinputMode: "adjustResize"
				//  });

			}

			function addEvent() {
				var dDate = new Date();

				// 开始时间
				$('#start_date_box').off().on('tap', function () {

					plus.nativeUI.pickDate(function (e) {
						var d = e.date;
						$('#start_date').val(d.format('yyyy-MM-dd'));

						plus.nativeUI.pickTime(function (e) {
							var d = e.date;
							$('#start_date').val($('#start_date').val() + d.format(' hh:mm:ss'));
						}, function (e) {
							$('#start_date').val("未选择时间：" + e.message);
						});
					}, function (e) {
						$('#start_date').val('您没有选择日期');
					}, {
							title: '',
							date: dDate,
							maxDate: dDate
						});
				});

				// 结束时间
				$('#end_date_box').off().on('tap', function () {

					plus.nativeUI.pickDate(function (e) {
						var d = e.date;
						$('#end_date').val(d.format('yyyy-MM-dd'));

						plus.nativeUI.pickTime(function (e) {
							var d = e.date;
							$('#end_date').val($('#end_date').val() + d.format(' hh:mm:ss'));
						}, function (e) {
							$('#end_date').val("未选择时间：" + e.message);
						});

					}, function (e) {
						$('#end_date').val('您没有选择日期');
					}, {
							title: '',
							date: dDate,
							maxDate: dDate
						});
				});

				// 
				$('#btn').on('tap', function () {
					if (!flag) {
						$(this).removeClass('icon-arrowup').addClass('icon-arrowdown')
						$('.bottom-search').css('bottom', '0px')
					} else {
						$(this).removeClass('icon-arrowdown').addClass('icon-arrowup')
						$('.bottom-search').css('bottom', bottom)
					}
					flag = !flag
				})
				// 更改标题
				$('.mui-segmented-control').on('tap', '.mui-control-item', function () {
					$('.mui-title').html($(this).html())
					if ($(this).html() == '实时监控') {
						$('.date-container').hide();
						bottom = '-70px';
					}
					if ($(this).html() == '车辆轨迹') {
						$('.date-container').css('display', 'flex');
						bottom = '-130px';
					}
					$('#btn').removeClass('icon-arrowdown').addClass('icon-arrowup')
					$('.bottom-search').css('bottom', bottom)
					flag = false;
				})

			}

			// fetchData()
			function fetchData() {
				// 实时数据查询
				app.carData({
					vSn: vSn
				}, function (res) {
					res = JSON.parse(res);
					console.log(res);
					updateView.carData(res)
				});

				app.carTrack({
					vSn: vSn,
					startDate: $('#start_date').val(),
					endDate: $('#end_date').val()
				}, function (res) {
					console.log(res)
					res = JSON.parse(res)
					// if (res.length <= 0) {
					//   mui.toast('没有数据');
					//   return;
					// }
					updateView.carTrack(res)
				})

				app.allcar({}, function (res) {
					console.log(res)
					res = JSON.parse(res);
					// if(res.length<=0) {
					// 	return;
					// }
					updateView.allcar(res)
				})
			}

			var updateView = {
				carData: function (data) {
					data.longitude = 116.404844;
					data.latitude = 39.915378;
					data.name = '奥迪'
					console.log(JSON.stringify(data))
					var point = new BMap.Point(data.longitude, data.latitude)
					// points.push(point);
					//坐标转换完之后的回调函数
					translatePoint(point, function (res) {
						var point = res.points[0];
						console.log(JSON.stringify(point))
						map2.centerAndZoom(point, 11);
						addMarker(point, map2, data)
					})

				},
				carTrack: function (data) {
					map1.setZoom(11)

					// 获取车辆位置点集，这里使用假数据
					var pts = [
						new BMap.Point(121.601, 31.3274),
						new BMap.Point(121.616, 31.1610),
						new BMap.Point(121.501, 30.1610),
						new BMap.Point(120.501, 30.1610),
						new BMap.Point(119.501, 30.1610),
						new BMap.Point(118.501, 30.1610),
						new BMap.Point(117.501, 30.1610),
						new BMap.Point(116.501, 30.1610),
						new BMap.Point(115.501, 30.1610),
						new BMap.Point(114.501, 30.1610)
					];
					//展示线条
					var polyline;
					// 轨迹配置项
					var options = {
						onSearchComplete: function (results) {
							if (driving.getStatus() == BMAP_STATUS_SUCCESS) {
								// 获取第一条方案
								var plan = results.getPlan(0);
								// 获取方案的驾车线路
								var route = plan.getRoute(0);
								//返回路线的地理坐标点数组。（自 1.2 新增）
								var points = route.getPath();
								polyline = new BMap.Polyline(points);
								map1.addOverlay(polyline); //增加折线
							}
						}
						//,
						//renderOptions:{map: map1, autoViewport: true}
					};
					// 创建轨迹实例
					var driving = new BMap.DrivingRoute(map1, options);
					// 索引
					var i = 0;

					// 轨迹实现方法
					function playLine(i) {
						if (i == 0) { //第一个点 直接添加
							// var marker = new BMap.Marker(pts[i]); // 创建标注
							// map1.addOverlay(marker);
							// marker.setLabel(new BMap.Label("我是第" + (i + 1) + "个点", { offset: new BMap.Size(20, -10) }));
							map1.centerAndZoom(pts[i], 11);
							map1.panTo(pts[i]);
							i++;
							setTimeout(function () {
								playLine(i);
							}, 2000)
						} else { //获取PolyLine并添加 添加点
							if (i < pts.length) {
								driving.search(pts[i - 1], pts[i]);
								map1.addOverlay(polyline);
								// var marker = new BMap.Marker(pts[i]); // 创建标注
								// map1.addOverlay(marker);
								addMarker(pts[0], map1)
								addMarker(pts[pts.length - 1], map1)

								// marker.setLabel(new BMap.Label("我是第" + (i + 1) + "个点", { offset: new BMap.Size(20, -10) }));
								map1.panTo(pts[i]);
								i++;
								setTimeout(function () {
									playLine(i);
								}, 10)
							}
						}

						map1.setViewport(pts)
					}

					playLine(i);

				},
				allcar: function (data) {
					data = [
						{
							longitude: 108.929346,
							latitude: 34.303791,
							name: '奥迪'
						},
						{
							longitude: 108.929202,
							latitude: 34.283391,
							name: '奥迪'
						},
						{
							longitude: 108.929202,
							latitude: 34.276471,
							name: '奥迪'
						},
						{
							longitude: 108.928771,
							latitude: 34.275397,
							name: '奥迪'
						}
					]

					map2.centerAndZoom(new BMap.Point(data[0].longitude, data[0].latitude), 14);
					map2.clearOverlays();       //清除地图上所有覆盖物

					if (!document.createElement('canvas').getContext) {
						alert('请在chrome、safari、IE8+以上浏览器查看');
						return;
					}

					var points = [];
					for (let i = 0; i < data.length; i++) {
						const item = data[i];
						var point = new BMap.Point(item.longitude, item.latitude)
						// 添加信息
						// ···
						points.push(point);
					}


					translatePoint(points, function (res) {
						var point = res.points[0];
						map2.centerAndZoom(point, 11);

						for (let i = 0; i < res.points.length; i++) {
							const item = res.points[i];
							addMarker(item, map2, data[i])
						}

					})

					// var options = {
					// 	size: BMAP_POINT_SIZE_BIG,
					// 	shape: BMAP_POINT_SHAPE_WATERDROP,
					// 	color: '#d340c3'
					// }
					// console.log(JSON.stringify(points))

					// var pointCollection = new BMap.PointCollection(points, options);  // 初始化PointCollection
					// pointCollection.addEventListener('click', function (e) {
					// 	alert('单击点的坐标为：' + e.point.lng + ',' + e.point.lat);  // 监听点击事件
					// });
					// map2.addOverlay(pointCollection);  // 添加Overlay
				}
			}

			// 获取位置信息
			
			function getLocation() {
				if (navigator.geolocation) {
					navigator.geolocation.getCurrentPosition(showPosition, showError);
				} else {
					alert("浏览器不支持地理定位。");
				}
			}

			// 位置获取失败
			function showError(error) {
				switch (error.code) {
					case error.PERMISSION_DENIED:
						alert("定位失败,用户拒绝请求地理定位");
						break;
					case error.POSITION_UNAVAILABLE:
						alert("定位失败,位置信息是不可用");
						break;
					case error.TIMEOUT:
						alert("定位失败,请求获取用户位置超时");
						break;
					case error.UNKNOWN_ERROR:
						alert("定位失败,定位系统失效");
						break;
				}
			}

			// 位置获取成功
			function showPosition(position) {
				var lat = position.coords.latitude; //纬度 
				var lag = position.coords.longitude; //经度 
				var point = new BMap.Point(lag, lat);
				translatePoint(point, function (res) {
					var point = res.points[0];
					var marker1 = new BMap.Marker(point);
					var marker2 = new BMap.Marker(point);

					map1.centerAndZoom(point, 16);
					map1.addOverlay(marker1);
					map2.centerAndZoom(point, 16);
					map2.addOverlay(marker2);
					// addMarker(point, map1)
					// addMarker(point, map2)
				})
			}

			
			// 状态栏颜色更改
			document.addEventListener('statusBar', function (e) {
				plus.navigator.setStatusBarStyle('light');
				fetchData()
			})
		})()

	</script>
</body>

</html>