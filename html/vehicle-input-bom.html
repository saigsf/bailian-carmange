<!doctype html>
<html>

<head>
  <meta charset="UTF-8">
  <title>BOM零部件查验</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-status-bar-style" content="black">
  <!--mui样式应用-->
  <link href="../css/mui.min.css" rel="stylesheet" />
  <!--自定义图标样式-->
  <link rel="stylesheet" type="text/css" href="../css/style-icon.css" />
  <!--自定义页面样式-->
  <link rel="stylesheet" type="text/css" href="../css/style-common.css" />
  <!--独立样式-->

  <style type="text/css">
    td {
      min-height: 40px;
    }

    .info-operator {
      flex-direction: column;
    }

    .info-operator-item {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }

    .info-operator-item p {
      width: 50%;
      margin: 0;
    }

    .info-operator-item span {
      display: inline;
    }

    #openPopover {
      display: none;
      padding: 6px 12px;
    }
  </style>
</head>

<body>
  <header class="mui-bar mui-bar-nav">
    <a class="mui-action-back icon icon-back mui-pull-left"></a>
    <h1 class="mui-title">BOM零部件查验</h1>
    <a href="#" id="openPopover" class="mui-btn mui-btn-outlined mui-pull-right">修改</a>
  </header>
  <!--页面主内容区开始-->
  <div class="mui-content mui-scroll-wrapper" id="app">
    <div class="mui-scroll">
      <!-- BOM零部件申请start -->
      <form id="form_one_bom">
        <table>
          <thead>
            <tr>
              <td width="75%">零部件名称</td>
              <td>零部件编号</td>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>
                <input type="text" name="bomName" value="ECM发动机电子控制模块-MT92.1">
              </td>
              <td>
                <input type="text" name="bomNum" value="">
              </td>
            </tr>
            <tr>
              <td>
                <input type="text" name="bomName" value="高压燃油油轨总成">
              </td>
              <td>
                <input type="text" name="bomNum" value="">
              </td>
            </tr>
            <tr>
              <td>
                <input type="text" name="bomName" value="高压油泵总成">
              </td>
              <td>
                <input type="text" name="bomNum" value="">
              </td>
            </tr>
            <tr>
              <td>
                <input type="text" name="bomName" value="MAP/MAT sensor进气压力温度传感器">
              </td>
              <td>
                <input type="text" name="bomNum" value="">
              </td>
            </tr>
            <tr>
              <td>
                <input type="text" name="bomName" value="Fron Oxygen Sensor前氧传感器">
              </td>
              <td>
                <input type="text" name="bomNum" value="">
              </td>
            </tr>
            <tr>
              <td>
                <input type="text" name="bomName" value="Rear Oxygen Sensor后氧传感器">
              </td>
              <td>
                <input type="text" name="bomNum" value="">
              </td>
            </tr>
            <tr>
              <td>
                <input type="text" name="bomName" value="Fuel Rail Assembly燃油导轨总成">
              </td>
              <td>
                <input type="text" name="bomNum" value="">
              </td>
            </tr>
            <tr>
              <td>
                <input type="text" name="bomName" value="Knock Sensor 爆震传感器">
              </td>
              <td>
                <input type="text" name="bomNum" value="">
              </td>
            </tr>
            <tr>
              <td>
                <input type="text" name="bomName" value="Crank Position sensor曲轴位置传感器">
              </td>
              <td>
                <input type="text" name="bomNum" value="">
              </td>
            </tr>
            <tr>
              <td>
                <input type="text" name="bomName" value="Purge Solenoid-ECP炭罐电磁阀">
              </td>
              <td>
                <input type="text" name="bomNum" value="">
              </td>
            </tr>
            <tr>
              <td>
                <input type="text" name="bomName" value="ETC电子节气阀体总成">
              </td>
              <td>
                <input type="text" name="bomNum" value="">
              </td>
            </tr>
            <tr>
              <td>
                <input type="text" name="bomName" value="coolant Sensor 冷却液温度传感器">
              </td>
              <td>
                <input type="text" name="bomNum" value="">
              </td>
            </tr>
            <tr>
              <td>
                <input type="text" name="bomName" value="Boot P/T sensor增压压力温度传感器">
              </td>
              <td>
                <input type="text" name="bomNum" value="">
              </td>
            </tr>
            <tr>
              <td>
                <input type="text" name="bomName" value="" placeholder="添加">
              </td>
              <td>
                <input type="text" name="bomNum" value="">
              </td>
            </tr>
          </tbody>
        </table>

      </form>
      <!-- BOM零部件申请end -->
      <div class="info-operator hide">
        <div class="info-operator-item">
          <p>
            <span>申请人：</span>
            <span class="applyPerson"></span>
          </p>
          <p>
            <span>申请日期：</span>
            <span class="applyTime"></span>
          </p>

        </div>

      </div>
      <!-- 提交 -->
      <div class="btn-wrapper ">
        <div class="btn btn-blue" id="vehicle-input-tools">下一步</div>
      </div>

    </div>
  </div>
  <!--页面主内容区结束-->
  <!-- jquery -->
  <script src="../js/lib/jquery.min.js"></script>
  <!-- mui -->
  <script src="../js/mui.min.js"></script>
  <!-- config 配置项 -->
  <script src="../js/app/config.js"></script>
  <!-- app 数据获取 -->
  <script src="../js/app/app.js"></script>
  <!-- 当前页面js -->
  <script type="text/javascript">
    var H = null;
    var self = null; // 当前页面
    var view = null; // 上页面
    var vSn = '2018ICECTC022'; // 车辆编码
    var oneInfo = null; //基本信息
    var upCheckInfo = null;

    var canBomCheck = false;
    var isFirst = false;

    var isModify = false;

    mui.init();
    mui('.mui-scroll-wrapper').scroll();
    mui.plusReady(function () {
      handsetAdaption();
      $('.mui-scroll').css('min-height', $('.mui-content').height())
      self = plus.webview.currentWebview();
      view = plus.webview.getWebviewById('vehicle-input')
      H = self.H;
      vSn = self.vSn;
      oneInfo = self.oneInfo;
      upCheckInfo = self.upCheckInfo;
      isModify = self.isModify;
      isFirst = self.isFirst;
      if (!isFirst) {
        $('#openPopover').show()
        $('.info-operator').css('display', 'flex')
      } else {
        $('.info-operator').hide()
      }
      fetchData();
      submitData();
    })

    function handsetAdaption() {
      if (plus.device.model === 'iPhoneX') {
        //页面样式重置
        $('header').css({
          'height': '88px',
          'paddingTop': '40px'
        });
        $('.mui-bar-nav~.mui-content').css({
          'paddingTop': '88px'
        })
      }
      plus.webview.currentWebview().setStyle({
        softinputMode: "adjustResize" // 弹出软键盘时自动改变webview的高度
      });
    }

    function fetchData() {
      app.findEmsAndBomCheckByvSn({ vSn }, function (res) {
        console.log(res);
        if (res.checkResults.length <= 0) {
          canBomCheck = false;
          return;
        }

        $('.applyPerson').html(res.check.applyPerson)
        $('.applyTime').html(res.check.applyTime)
        updateView(res.checkResults)

      }, function (xhr, type, errorThrown) {
        //异常处理；
        console.log(type);
        mui.toast(type);
        if (type == 'timeout') {
          console.log("请求超时：请检查网络")
        } else {
          console.log('请求失败：' + type + '\n err:' + errorThrown);
        }
      })
    }


    function updateView(data) {
      var html = '';
      for (let i = 0; i < data.length; i++) {
        const item = data[i];
        html += '<tr data-uuid="' + item.uuid + '">\
              <td>\
                <input type="text" name="bomName" value="'+ item.bomName + '">\
              </td>\
              <td>\
                <input type="text" name="bomNum" value="'+ item.bomNum + '">\
              </td>\
            </tr>'
      }


      html += '<tr>\
              <td>\
                <input type="text" name="bomName" value="" placeholder="添加">\
              </td>\
              <td>\
                <input type="text" name="bomNum" value="">\
              </td>\
            </tr>'

      $('table tbody').html(html)
      $('input').attr('readonly', true)
    }


    submitData()
    function submitData() {
      // vSn = '2018ICECTC001'
      $('#vehicle-input-tools').on('tap', function () {
        var oneBom = [];
        var $bomTr = $('#form_one_bom tr');

        $bomTr.each(function (i) {
          var $bomName = $(this).find('input[name=bomName]');
          var $bomNum = $(this).find('input[name=bomNum]');
          if ($bomName.val() && $bomNum.val()) {
            oneBom.push({
              bomName: $bomName.val(),
              bomNum: $bomNum.val(),
              uuid: $(this).attr('data-uuid') ? $(this).attr('data-uuid') : '',
              vSn: vSn
            })
          }
        })

        var id = $(this).attr('id');
        mui.openWindow({
          url: id + '.html',
          id: id, //默认使用当前页面的url作为id
          styles: {
            top: '0px',
            // bottom: H,
            hardwareAccelerated: true
          }, //窗口参数
          extras: {
            H: H,
            vSn: vSn,
            oneBom: oneBom,
            oneInfo: oneInfo,
            upCheckInfo: upCheckInfo,
            isModify: isModify,
            isFirst: isFirst
          } //自定义扩展参数
        })
      })

    }

    $('#openPopover').on('tap', function () {
      if ($(this).html() == '修改') {
        canBomCheck = true;
        $(this).html('取消');
        $('input').attr('readonly', false)
        // isModify = true;
      } else {
        canBomCheck = false;
        $(this).html('修改');
        $('input').attr('readonly', true)
        // isModify = false;
      }

      isModify = canBomCheck || isModify
    })


    $('table tbody ').on('focus', 'tr:last td:first input', function () {
      $('table tbody').append('<tr><td><input type="text" name="bomName" value="" placeholder="添加"></td><td><input type="text" name="bomNum" value=""></td></tr>');
      $(this).attr('placeholder', '')
    })
    $('table tbody').on('blur', 'input[name=bomName]', function () {
      if(!$(this).val()) {
        $(this).parents('tr').remove()
      }
    })

    // 返回事件
    document.addEventListener('goback', function () {
      mui.back();
      mui.fire(view, 'goback', {});
    })
  </script>
</body>

</html>