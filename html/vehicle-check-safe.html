<!doctype html>
<html>

<head>
  <meta charset="UTF-8">
  <title>安全检查</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-status-bar-style" content="black">
  <!--mui样式应用-->
  <link href="../css/mui.min.css" rel="stylesheet" />
  <!--自定义图标样式-->
  <link rel="stylesheet" type="text/css" href="../css/style-icon.css" />
  <!--自定义页面样式-->
  <link rel="stylesheet" type="text/css" href="../css/style-common.css" />
  <!--独立样式-->

  <style type="text/css">
    .pressure {
      padding: 15px;
      width: 94%;
      margin: 15px auto;
      background-color: #fff;
      border-radius: 5px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, .3);
    }

    .pressure input[type=number] {
      margin: 0;
      height: 34px;
      font-size: 14px;
    }

    .pressure-vat {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      padding-bottom: 15px;
      border-bottom: 1px dashed #999;
    }

    .vat-left {
      width: 15%;
      line-height: 30px;
      position: relative;
    }

    .vat-left p {
      margin: 0;
      color: #333;
    }

    .vat-left:after {
      content: "";
      height: 50%;
      width: 0;
      border-left: 1px dashed #999;
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
    }

    .vat-right {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      width: 85%;
      flex-wrap: wrap;
    }

    .vat-right-item {
      width: 50%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      padding-left: 15px;
    }

    .vat-right-item:nth-child(1),
    .vat-right-item:nth-child(2) {
      margin-bottom: 10px;
    }

    .vat-right-item label {
      width: 30%;
      font-size: 12px;
    }

    .vat-right-item select {
      border: 1px solid #999 !important;
      padding: 5px 10px;
      color: #999;
      font-size: 12px;
    }

    .vat-right-item i {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #999;
      font-size: 20px
    }

    .pressure-oil {
      padding-top: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .oil-left {
      width: 35%;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      position: relative;
    }

    .oil-left:after {
      content: "";
      height: 50%;
      width: 0;
      border-left: 1px dashed #999;
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
    }

    .oil-left label {
      width: 63%;
      text-align: center;
      padding-right: 15px;
      position: relative;
    }

    .oil-left label:after {
      content: ":";
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
    }

    .oil-right {
      width: 65%;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      position: relative;
    }

    .oil-right label {
      padding: 0 0 0 10px;
      line-height: 40px;
      /*width: 22%;*/
    }

    .oil-right label:before {
      display: none;
    }

    .oil-right input {
      width: 78% !important;
      border: 1px solid #999 !important;
      padding: 5px 10px !important;
      font-size: 12px;
    }

    .oil-right span {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
    }

    select {
      margin: auto;
      background-color: transparent;
    }
    .select-container {
      width: 100%;
      text-align: center;
    }
    .select-container select  {
      padding-left: 10px;
    }

    .explain,
    .resolvent {
      font-size: 24px;
    }

    .mui-popover {
      width: 140px;
    }

    .info-operator {
      flex-direction: column;
    }

    .info-operator-item {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }

    .info-operator-item p {
      width: 50%;
      margin: 0;
    }

    .info-operator-item span {
      display: inline;
    }
    #openPopover {
      display: none
    }
  </style>
</head>

<body>
  <header class="mui-bar mui-bar-nav">
    <a class="mui-action-back mui-pull-left">
      <i class="icon-back icon"></i>
    </a>
    <h1 class="mui-title">安全检查</h1>
    <!-- #popover -->
    <a href="#popover" id="openPopover" class="mui-btn mui-btn-outlined mui-pull-right">修改</a>
  </header>
  <!--页面主内容区开始-->
  <div class="mui-content mui-scroll-wrapper" id="app">
    <div class="mui-scroll">
      <form class="pressure" id="pressure">
        <div class="pressure-vat">
          <div class="vat-left">
            <p>缸压</p>
            <p>(Bar)</p>
          </div>
          <div class="vat-right">
            <div class="vat-right-item">
              <label>1缸</label>
              <input type="number" name="one_p" id="one_p">
            </div>
            <div class="vat-right-item">
              <label>2缸</label>
              <input type="number" name="two_p" id="two_p">
            </div>
            <div class="vat-right-item">
              <label>3缸</label>
              <input type="number" name="three_p" id="three_p">
            </div>
            <div class="vat-right-item">
              <label>4缸</label>
              <input type="number" name="four_p" id="four_p">
            </div>
          </div>
        </div>
        <div class="pressure-oil">
          <div class="oil-left">
            <label>燃油压力(kPa)</label>
            <span id="fuel_p">4.0</span>Bar
          </div>
          <div class="mui-input-row oil-right">
            <label>实测：</label>
            <input name="actual_p" id="actual_p" type="number" value="" placeholder="请输入实测数据" />
            <span>/Bar</span>
          </div>
        </div>
      </form>
      <table>
        <thead>
          <tr>
            <td width="45%">检查项目</td>
            <td width="20%">要求</td>
            <td width="15%">状态</td>
            <td width="20%">检查进度</td>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="info-operator">
        <div class="info-operator-item">
          <p>
            <span>检查人：</span>
            <span class="checkPerson"></span>
          </p>
          <p>
            <span>检查日期：</span>
            <span class="checkTime"></span>
          </p>

        </div>
        <div class="info-operator-item">
          <p>
            <span>核对人：</span>
            <span class="checkingPerson"></span>
          </p>
          <p>
            <span>核对日期：</span>
            <span class="checkingTime"></span>
          </p>
        </div>
        <div class="info-operator-item">
          <p>
            <span>确认人：</span>
            <span class="confirmPerson"></span>
          </p>
          <p>
            <span>确认日期：</span>
            <span class="confirmTime"></span>
          </p>
        </div>
      </div>
      <div class="btn-wrapper ">
        <div class="btn btn-blue" id="two_next">提交</div>
      </div>
    </div>
  </div>
  <!--页面主内容区结束-->

  <div id="popover" class="mui-popover">
    <ul class="mui-table-view">
      <li class="mui-table-view-cell">
        <a href="javascript:;">修改检查项</a>
      </li>
      <li class="mui-table-view-cell">
        <a href="javascript:;">修改核对项</a>
      </li>
      <li class="mui-table-view-cell">
        <a href="javascript:;">修改确认项</a>
      </li>
    </ul>
  </div>
  <!-- jquery -->
  <script src="../js/lib/jquery.min.js"></script>
  <!-- mui -->
  <script src="../js/mui.min.js"></script>
  <!-- config 配置项 -->
  <script src="../js/app/config.js"></script>
  <!-- app 数据获取 -->
  <script src="../js/app/app.js"></script>
  <!-- 当前页面js -->
  <script type="text/javascript">
    var H = null;
    var self = null;
    var view = null;
    var viewId = null;
    var vSn = '2018-513';
    var status = 'explain'
    var state = null;
    var stateArr = [];
    var submitArr = ['saveClacyLindersss', 'addSafeCheck'];
    var updateArr = ['updateCldCheckByvSn', 'updateSafeCheckByvSn'];
    var confrimArr = ['updateCldCheckByvSn', 'confirmSafeCheckByvSn'];
    var canInspect = true; // 可以检查
    var canChecked = true; // 可以核对

    var submitLock = false; // 提交保护
    var urlSafeCheck = null;
    var urlCldCheck = null;

    var isRevising = false; // 修改索订


    var form = document.getElementsByTagName('form')[0];

    form.onsubmit = function (e) {
      e.preventDefault(); // 取消默认事件
    }

    var fetchData = {
      findCldCheckByvSn: function () {
        // 缸压查看
        app.findCldCheckByvSn({
          vSn: vSn
        }, function (res) {
          // console.log(res);
          if (res == null) {
            // mui.toast('缸压检查未完成')
            return;
          }
          updateView.cldCheck(res);
        }, function (xhr, type, errorThrown) {
          //异常处理；
          console.log(type);
          mui.toast(type);
          if (type == 'timeout') {
            console.log("请求超时：请检查网络")
          } else {
            console.log('请求失败：' + type + '\n err:' + errorThrown);
          }
        })
      },
      findSafeCheckByvSn: function () {
        app.findSafeCheckByvSn({
          vSn: vSn
        }, function (res) {
          console.log(res);
          updateView.safeCheck(res);

        }, function (xhr, type, errorThrown) {
          //异常处理
          mui.toast(type);
          if (type == 'timeout') {
            console.log("请求超时：请检查网络")
          } else {
            console.log('请求失败：' + type + '\n err:' + errorThrown);
          }
        })
      }
    }
    // 更新视图 
    var updateView = {
      cldCheck: function (data) {
        $('#one_p').val(data.one_p);
        $('#two_p').val(data.two_p);
        $('#three_p').val(data.three_p);
        $('#four_p').val(data.four_p);
        $('#actual_p').val(data.actual_p);
        $('#pressure').attr('data-id', data.id);
        $('#pressure').find('input').attr('readonly', true)
      },
      safeCheck: function (res) {
        var data = res.checkResults
        var $safeTr = $('table tbody tr');
        
        if(!res.check && data.length === 0) {
          return;
        }
        var a = res.check.checkPerson
        var b = res.check.checkingPerson
        var c = res.check.confirmPerson
        console.log(a,b,c)
        $safeTr.each(function (i) {
          var x = data[i].checkExplanation
          var y = data[i].checkingExplanation
          var z = data[i].confirmExplanation

          $(this).attr('data-uuid', data[i].uuid)
          $(this).find('select.status').val(data[i].status);
          $(this).find('.explainText').val(x)
          $(this).find('.resolventText').val(y)
          $(this).find('.confirmText').val(z)
          if (!a) {
            $(this).find('.checkSpeed').html('未说明').addClass('unfinished').data('status', 'explain')
            status = 'explain'
            $('#openPopover').hide()
          } else if (!b) {
            if(x) {
              $(this).find('.checkSpeed').html('未解决').addClass('unfinished').data('status', 'resolvent') // 核对人
              $(this).find('select').addClass('unfinished')
            } else {
              $(this).find('.checkSpeed').html('完成').removeClass('unfinished').addClass('finished').data('status', 'resolvent') // 核对人
            }
            status = 'resolvent'
            $('#openPopover').show()
          } else if (!c) {
            if(x && y) {
              // $(this).find('.checkSpeed').html('已解决').data('status', 'confirm') // 核对人
              $(this).find('.checkSpeed').html('未确认').addClass('unfinished').data('status', 'confirm') // 确认人
              $(this).find('select').addClass('unfinished')
            } else if (x && !y) { 
              // $(this).find('.checkSpeed').html('未解决').data('status', 'confirm') // 核对人
              $(this).find('.checkSpeed').html('未完成').addClass('unfinished').data('status', 'resolvent') // 确认人 
              $(this).find('select').addClass('unfinished')
            } else {
              $(this).find('.checkSpeed').html('完成').removeClass('unfinished').addClass('finished').data('status', 'explain')
            }
            status = 'confirm'
            $('#openPopover').show()
          } else {
            if(x && y && z) {
              $(this).find('.checkSpeed').html('查看').addClass('unfinished').data('status', '')
            } else if(x && y && !z) {
              $(this).find('.checkSpeed').html('未确认').data('status', 'confirm')
            } else if(x && !y && !z) {
              $(this).find('.checkSpeed').html('未完成').data('status', 'resolvent')
            } else {
              $(this).find('.checkSpeed').html('完成').removeClass('unfinished').addClass('finished').data('status', 'explain')
            }
            status = ''
            $('#two_next').parent().hide()
            $('#openPopover').show()
          }
          
        })

        $('.checkPerson').html(res.check.checkPerson ? res.check.checkPerson : '')
        $('.checkTime').html(res.check.checkTime ? res.check.checkTime : '')
        $('.checkingPerson').html(res.check.checkingPerson ? res.check.checkingPerson : '')
        $('.checkingTime').html(res.check.checkingTime ? res.check.checkingTime : '')
        $('.confirmPerson').html(res.check.confirmPerson ? res.check.confirmPerson : '')
        $('.confirmTime').html(res.check.confirmTime ? res.check.confirmTime : '')
        
      }
    }

    mui.init();
    //初始化单页的区域滚动
    mui('.mui-scroll-wrapper').scroll();
    mui.plusReady(function () {
      handsetAdaption();
      $('.mui-scroll').css('min-height', $('.mui-content').height())
      self = plus.webview.currentWebview();
      view = plus.webview.getWebviewById(self.prevId)
      viewId = self.id;
      H = self.H;
      vSn = self.vSn;
      state = app.getState();
      fetchData.findCldCheckByvSn()
      // 页面表格初始化
      _init()
    })

    function handsetAdaption() {
      if (plus.device.model === 'iPhoneX') {
        //页面样式重置
        $('header').css({
          'height': '88px',
          'paddingTop': '40px'
        });
        $('.mui-bar-nav~.mui-content').css({
          'paddingTop': '88px'
        })
      }
      // plus.webview.currentWebview().setStyle({
      //   softinputMode: "adjustResize" // 弹出软键盘时自动改变webview的高度
      // });
    }
    // _init()
    // 表格初始化
    function _init() {
      var itemJson = [{
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "电瓶固定牢固/电瓶桩头紧固/电瓶线束检查",
          "request": "紧固无漏",
          "status": "Y"
        },
        {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "机油液位",
          "request": "正常无漏",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "防冻液液位",
          "request": "紧固无漏",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "变速箱油位",
          "request": "紧固无漏",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "刹车油位管路",
          "request": "紧固无漏",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "助力转向油位",
          "request": "紧固无漏",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "电子助力转向",
          "request": "正常",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "转向机连接",
          "request": "正常",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "燃油管路连接",
          "request": "正常",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "排气系统隔热罩",
          "request": "已安装",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "进气系统管路连接",
          "request": "正常",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "油门状态",
          "request": "正常",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "制动功能",
          "request": "正常",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "离合器分离",
          "request": "正常",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "驻车制动状态",
          "request": "正常",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "档位状态",
          "request": "正常",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "轮胎",
          "request": "已紧固",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "轮胎胎压",
          "request": "正常",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "倒车镜状态",
          "request": "正常",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "全车灯光",
          "request": "正常",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "雨刷状态",
          "request": "正常",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "喇叭状态",
          "request": "正常",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "安全带状态",
          "request": "正常",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "摇窗机状态",
          "request": "正常",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "门锁状态",
          "request": "正常",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "全车玻璃状态",
          "request": "正常",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "驾驶室内机仓盖拉锁功能",
          "request": "正常",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "仪表状态",
          "request": "正常",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "空调工作状态",
          "request": "正常",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "燃油箱进出接头",
          "request": "紧固无漏",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "ECM发动机电子控制模块",
          "request": "紧固无漏",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "MAP/MAT sensor进气歧管压力温度传感器",
          "request": "紧固无漏",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "Fron Oxygen Sensor前氧传感器",
          "request": "紧固无漏",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "Rear Oxygen Sensor后氧传感器",
          "request": "紧固无漏",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "Fuel Rail Assembly燃油导轨总成",
          "request": "紧固无漏",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "Knock Sensor 爆震传感器",
          "request": "紧固无漏",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "Crank Position sensor曲轴位置传感器",
          "request": "紧固无漏",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "Purge Solenoid-ECP炭罐电磁阀",
          "request": "紧固无漏",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "ETC电子节气阀体总成",
          "request": "紧固无漏",
          "status": "Y"

        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "coolant Sensor 冷却液温度传感器",
          "request": "紧固无漏",
          "status": "Y"
        }, {
          "checkExplanation": "",
          "confirmExplanation": "",
          "checkingExplanation": "",
          "item": "Boot P/T sensor增压压力温度传感器",
          "request": "紧固无漏",
          "status": "Y"
        }
      ]
      var html = ''
      mui.each(itemJson, function(k, item) {
        html += '<tr>' +
          '<td class="item">' + item.item + '</td>' +
          '<td class="request">' + item.request + '</td>' +
          '<td>' +
          '<div class="select-container">' +
          '<select name="status" class="status">' +
          '<option value="Y">是</option>' +
          '<option value="N">否</option>' +
          '<option value="NA">NA</option>' +
          '</select>' +
          // '<i class="mui-icon mui-icon-arrowdown"></i>' +
          '</div>' +
          '</td>' +
          '<td>' +
          '<span class="checkSpeed unfinished" data-status="explain">未说明</span>' +
          '<input class="explainText" type="hidden" value="' + item.checkExplanation + '">' +
          '<input class="resolventText" type="hidden" value="' + item.checkingExplanation + '">' +
          '<input class="confirmText" type="hidden" value="' + item.confirmExplanation + '">' +
          '</td>' +
          '</tr>'
      });
      $('table tbody').html('').append(html)
      fetchData.findSafeCheckByvSn()
    }

    // 添加说明
    $('table tbody').on('tap', '.checkSpeed', addExplanation)
    function addExplanation() {
      var _this = this;
      // console.log($(_this).data('status'))
      var explainText = $(_this).parents('tr').find('.explainText').val();
      var resolventText = $(_this).parents('tr').find('.resolventText').val();
      var confirmText = $(_this).parents('tr').find('.confirmText').val();
      var trId = $(_this).parents('tr').data('uuid')
      if($(_this).html() == '完成') {
        mui.alert('该项目正常，无检查信息', '提示')
        return
      }
      mui.openWindow({
        url: 'vehicle-check-add-explain.html',
        id: 'vehicle-check-add-explain', //默认使用当前页面的url作为id
        styles: {
          top: '0px',
          // bottom: H,
          hardwareAccelerated: true
        }, //窗口参数
        extras: {
          H: H,
          viewId: viewId,
          status: status,
          trId: trId,
          explainText: explainText,
          resolventText: resolventText,
          confirmText: confirmText
        } //自定义扩展参数
      })
    }

    document.removeEventListener('updateExplain', updateExplain, false)
    document.addEventListener('updateExplain', updateExplain, false);

    function updateExplain(evt) {
      evt.preventDefault()
      var data = evt.detail;
      mui.each(data, function(k, v) {
        console.log(k)
        if(k == 'html') {
          $('table tbody tr[data-uuid='+data.trId+']').find('.checkSpeed').html(v)
        } else {
          $('table tbody tr[data-uuid='+data.trId+']').find('.checkSpeed').addClass('unfinished').parents('tr').find('.'+k).val(v);
        }
      })
      $('table tbody tr[data-uuid='+data.trId+']').find('.status').val('N').addClass('unfinished')
      // status = $(_this).data('status')
    }
    
    // 提交数据
    var submitData = {
      clacyLindersss: function() {
        // 缸压检查获取数据
        var pressure = serialize($('#pressure'));
        pressure.fuel_p = $('#fuel_p').html()
        pressure.vSn = vSn
        // pressure.id = $('#pressure').attr('data-id')
        if (hasEmptyValue(pressure)) {
          submitLock = false;
          mui.toast('请填写完整的缸压数据');
          return;
        }
        app[stateArr[0]](pressure, function(res) {
          mui.toast(res.msg);
        }, function(err) {
          console.log(err)
        })
      },
      safeCheck: function() {
        // 安全检查获取数据
        var $safeTr = $('table tbody tr');
        var safeCheckResult = [];
        var data = {}

        $safeTr.each(function (i) {
          // console.log($(this).attr('data-uuid') ? $(this).attr('data-uuid') : '无')
          var obj = {
            'checkExplanation': $(this).find('.explainText').val(),
            'checkingExplanation': $(this).find('.resolventText').val(),
            'confirmExplanation': $(this).find('.confirmText').val(),
            'item': $(this).find('.item').html(),
            'request': $(this).find('.request').html(),
            'status': $(this).find('.status').val(),
            'vSn': vSn,
            'uuid': $(this).attr('data-uuid') ? $(this).attr('data-uuid') : ''
          }

          if (obj.status == 'N' && obj.checkExplanation == '') {
            $(this).find('.status').css('color', '#ff3a31')
          }
          safeCheckResult.push(obj)

        })

        mui.each(safeCheckResult, function (k, v) {
          // if ((v.status == 'Y' && v.checkExplanation != '') || (v.status == 'N' && v.checkExplanation == '')) {
          //   mui.alert('"' + v.item + '"未添加说明', '提示')
          //   submitLock = false;
          //   return;
          // }
          // if ((v.status == 'Y' && v.checkingExplanation != '') || (v.status == 'N' && v.checkingExplanation == '')) {
          //   mui.alert('"' + v.item + '"未添加解决方法', '提示')
          //   submitLock = false;
          //   return;
          // }
          // if ((v.status == 'Y' && v.confirmExplanation != '') || (v.status == 'N' && v.confirmExplanation == '')) {
          //   mui.alert('"' + v.item + '"未添加确认信息', '提示')
          //   submitLock = false;
          //   return;
          // }
        })
        data = {
          vSn: vSn,
          safeCheckResult: safeCheckResult
        }

        app[stateArr[1]](data, function(res) {
          mui.toast(res.msg);
          submitLock = false;
          if(res.ret) {
            submitLock = false;
            mui.back();
            mui.fire(view, 'update', null)
          }
        }, function(err) {
          console.log(err)
        })
      }
    }
    // 提交数据
    $('#two_next').on('tap', toSubmit)
    function toSubmit() {
      if (submitLock) {
        mui.toast('请不要重复操作！')
        return;
      }
      submitLock = true;
      if (status == 'explain') {
        stateArr = submitArr;
      } else if (status == 'resolvent') {
        stateArr = updateArr;
      } else if (status == 'confirm') {
        stateArr = confrimArr;
      }
      submitData.clacyLindersss()
      submitData.safeCheck()
    }
    
    // 修改
    $('#popover').on('tap', 'a', function () {
      var str = $(this).html()
      mui('.mui-popover').popover('hide');
      if(str == '修改检查项') {
        if (isRevising) {
          mui.alert('请先完成之前的修改操作', '提示')
          return;
        }
        isRevising = true
        status = 'explain'
        $(this).html('取消修改检查项')
        $('#two_next').html('确认修改').parent().show()
        $('#pressure').find('input').attr('readonly', false)
        $('table tbody tr').each(function(i) {
          var text = $(this).find('.checkSpeed').html()
          $(this).find('.checkSpeed').html('修改')
        })
      } else if (str == '修改核对项') {
        if (isRevising) {
          mui.alert('请先完成之前的修改操作', '提示')
          return;
        }
        isRevising = true
        status = 'resolvent'
        $(this).html('取消修改核对项')
        $('#two_next').html('确认修改').parent().show()
        $('#pressure').find('input').attr('readonly', false)
        $('table tbody tr').each(function(i) {
          var text = $(this).find('.checkSpeed').html()
          if(text == '未完成' || text == '查看') $(this).find('.checkSpeed').html('修改')
        })
      } else if(str == '修改确认项') {
        if (isRevising) {
          mui.alert('请先完成之前的修改操作', '提示')
          return;
        }
        isRevising = true
        status = 'confirm'
        $(this).html('取消修改确认项')
        $('#two_next').html('确认修改').parent().show()
        $('table tbody tr').each(function(i) {
          var text = $(this).find('.checkSpeed').html()
          if(text == '未确认' || text == '查看') $(this).find('.checkSpeed').html('修改')
        })
      } else if(str == '取消修改检查项') {
        isRevising = false
        status = 'explain'
        $(this).html('修改检查项')
        $('#two_next').parent().hide()
        $('#pressure').find('input').attr('readonly', true)
        _init()
      } else if (str == '取消修改核对项') {
        isRevising = false
        status = 'resolvent'
        $(this).html('修改核对项')
        $('#two_next').parent().hide()
        $('#pressure').find('input').attr('readonly', true)
        _init()
      } else if(str == '取消修改确认项') {
        isRevising = false
        status = 'confirm'
        $(this).html('修改确认项')
        $('#two_next').parent().hide()
        _init()
      }
    })

    // 页面刷新
    document.addEventListener('update', function () {
      fetchData.findCldCheckByvSn()
      fetchData.findSafeCheckByvSn()
    })
  </script>
</body>

</html>